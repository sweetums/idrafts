<?xml version="1.0" encoding="utf-8"?>

<!DOCTYPE rfc SYSTEM 'rfc2629.dtd'>
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>

<?rfc toc="yes"?>
<?rfc symrefs="yes"?>
<?rfc compact="no" ?>
<?rfc sortrefs="yes" ?>
<?rfc strict="yes" ?>
<?rfc linkmailto="yes" ?>


<rfc ipr="trust200902" docName="draft-ietf-kitten-sasl-oauth-19.txt" category="std">

  <front>
    <title abbrev="SASL OAuth">A set of SASL Mechanisms for OAuth</title>
    <author fullname="William Mills" initials="W." surname="Mills">
      <organization>Microsoft</organization>
      <address>
        <postal>
          <street/>
          <city/>
          <code/>
          <region/>
          <country/>
        </postal>
        <phone/>
        <email>wimills@microsoft.com</email>
      </address>
    </author>
    <author fullname="Tim Showalter" initials="T." surname="Showalter">
      <organization></organization>
      <address>
        <postal>
          <street/>
          <city/>
          <code/>
          <region/>
          <country/>
          </postal>
        <phone/>
        <email>tjs@psaux.com</email>
      </address>
    </author>

    <author initials="H.T." surname="Tschofenig" fullname="Hannes Tschofenig ">
      <organization>ARM Ltd.</organization>
      <address>
        <postal>
          <street>110 Fulbourn Rd</street>
          <city>Cambridge</city>
          <code> CB1 9NJ </code>
          <country>Great Britain</country>
        </postal>
        <email>Hannes.tschofenig@gmx.net </email>
        <uri>http://www.tschofenig.priv.at</uri>
      </address>
    </author>

    <date year="2015"/>
    <workgroup>KITTEN</workgroup>

    <abstract>
      <t>
        OAuth enables a third-party
   application to obtain limited access to a protected resource, either on
   behalf of a resource owner by orchestrating an approval interaction, or by allowing the
   third-party application to obtain access on its own behalf.
   </t>
      <t>This document defines how an application client uses credentials obtained via OAuth
        over the Simple Authentication and Security Layer (SASL)
        to access a protected resource at a resource serve.  Thereby, it enables
	schemes defined within the OAuth framework for non-HTTP-based application protocols.
      </t> 
      <t>Clients typically store the user's long-term credential. This does, however, lead to 
      significant security vulnerabilities, for example, when such a
      credential leaks. A significant benefit of OAuth for usage in
      those clients is that the password is replaced by a
      shared secret with higher entropy, i.e., the token. Tokens typically provide limited access rights and can
      be managed and revoked separately from the user's long-term password.
	</t>
    </abstract>
  </front>

  <middle>

    <!-- ******************************************************************** -->

    <section title="Introduction">

	<t>OAuth 1.0a <xref target="RFC5849"/> and OAuth 2.0 <xref target="RFC6749"/> are protocol frameworks that enable a third-party
	application to obtain limited access to a protected resource, either on
   	behalf of a resource owner by orchestrating an approval interaction, or by allowing the
   	third-party application to obtain access on its own behalf. </t>
	
	<t>The core OAuth 2.0
        specification <xref target="RFC6749"/> specifies the interaction between the OAuth client and the authorization server; it does not define the interaction between the 
        OAuth client and the resource server for the access to a protected resource using an Access Token. 
        Instead, the OAuth client to resource server interaction is described in separate specifications, such as the bearer token specification <xref
          target="RFC6750"/>. OAuth 1.0a included the protocol specification for the communication between the OAuth client and the resource server 
		in <xref target="RFC5849"/>. 
    </t> 
          
      <t>The main use cases for OAuth 2.0 and OAuth 1.0a have so far focused on an HTTP-based <xref target="RFC2616"/> environment only. 
This document integrates OAuth 1.0a and OAuth 2.0 into non-HTTP-based applications using the integration into SASL.
Hence, this document  takes
        advantage of the OAuth protocol and its deployment base to provide a way to use 
        the Simple Authentication and Security Layer (SASL) <xref target="RFC4422"/> to gain 
	access to resources when using non-HTTP-based protocols, such as the Internet Message 
	Access Protocol (IMAP) <xref target="RFC3501"/> and the Simple Mail Transfer Protocol (SMTP) 
	<xref target="RFC5321"/>, which is what this memo uses in the examples.</t>

<t>To illustrate the impact of integrating this specification into an OAuth-enabled application environment, <xref target="overview"/> shows the abstract message flow of OAuth 2.0 <xref target="RFC6749"/>. As indicated in the figure, this document impacts the exchange of messages (E) and (F) since SASL is used for interaction between the client and the resource server instead of HTTP.</t>
       
      <t>
        <figure anchor="overview" title="OAuth 2.0 Protocol Flow">
          <artwork><![CDATA[
                                                              ----+
   +--------+                                  +---------------+  |
   |        |--(A)-- Authorization Request --->|   Resource    |  |
   |        |                                  |     Owner     |  |Plain
   |        |<-(B)------ Access Grant ---------|               |  |OAuth
   |        |                                  +---------------+  |2.0
   |        |                                                     | 
   |        |         Client Credentials &     +---------------+  |
   |        |--(C)------ Access Grant -------->| Authorization |  |
   | Client |                                  |     Server    |  |
   |        |<-(D)------ Access Token ---------|               |  |
   |        |      (w/ Optional Refresh Token) +---------------+  |
   |        |                                                 ----+
   |        |                                                 ----+
   |        |                                  +---------------+  |
   |        |                                  |               |  |OAuth
   |        |--(E)------ Access Token -------->|    Resource   |  |over
   |        |                                  |     Server    |  |SASL
   |        |<-(F)---- Protected Resource -----|               |  |
   |        |                                  |               |  |
   +--------+                                  +---------------+  |
                                                              ----+
]]></artwork>
        </figure>
      </t>

<t>The Simple Authentication and Security Layer (SASL) is a framework
   for providing authentication and data security services in
   connection-oriented protocols via replaceable authentication mechanisms.  It
   provides a structured interface between protocols and mechanisms.
   The resulting framework allows new protocols to reuse existing
   authentication protocols and allows old protocols to make use of new authentication mechanisms.
   The framework also provides a protocol for securing subsequent
   exchanges within a data security layer.</t>
   
<t>When OAuth is integrated into SASL the high-level steps are as follows:
<list style="empty"> 
<t>  (A)  The client requests authorization from the resource owner.  The
        authorization request can be made directly to the resource owner
        (as shown), or preferably indirectly via the authorization
        server as an intermediary.</t>
<t>   (B)  The client receives an authorization grant which is a credential
        representing the resource owner's authorization, expressed using
        one of the grant types defined in <xref target="RFC6749"/> or <xref target="RFC5849"/> or using
        an extension grant type.  The authorization grant type depends
        on the method used by the client to request authorization and
        the types supported by the authorization server.</t>
<t>   (C)  The client requests an access token by authenticating with the
        authorization server and presenting the authorization grant.</t>
<t>   (D)  The authorization server authenticates the client and validates
        the authorization grant, and if valid issues an access token.</t>
<t>   (E)  The client requests the protected resource from the resource
        server and authenticates by presenting the access token.</t>
<t>   (F)  The resource server validates the access token, and if valid,
        indicates a successful authentication.</t>
</list> 
</t>

<t>
Again, steps (E) and (F) are not defined in <xref target="RFC6749"/> (but are
described in, for example, <xref target="RFC6750"/> for the OAuth Bearer Token
instead) and are the main functionality specified within this
document. Consequently, the message exchange shown in <xref target="overview"/> is the
result of this specification. The client will generally need to
determine the authentication endpoints (and perhaps the service
endpoints) before the OAuth 2.0 protocol exchange messages in steps
(A)-(D) are executed. The discovery of the resource owner, 
authorization server endpoints, and client registration are outside 
the scope of this specification. The client must discover the 
authorization endpoints using a discovery mechanism such as OpenID
Connect Discovery <xref target="OpenID.Discovery" /> or Webfinger using host-meta
<xref target="RFC7033"/>.  Once credentials are obtained the client proceeds to steps
(E) and (F) defined in this specification.  Authorization endpoints
MAY require client registration and generic clients SHOULD support
the Dynamic Client Registration protocol  <xref target="I-D.ietf-oauth-dyn-reg"/>.
      </t>

	  <t>OAuth 1.0 follows a similar model but uses a different terminology and 
	  does not separate the resource server from the authorization server.</t>
      
    </section>

    <!-- ******************************************************************** -->

    <section anchor="terminology" title="Terminology">
      <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT",
        "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in
	<xref target="RFC2119"/>.</t>
      <t>The reader is assumed to be familiar with the terms used in the OAuth 2.0 specification <xref
          target="RFC6749"/> and SASL <xref target="RFC4422"/>.</t>
      <t>In examples, "C:" and "S:" indicate lines sent by the client and server respectively. Line
        breaks have been inserted for readability.</t>
      <t>Note that the IMAP SASL specification requires base64 encoding, see Section 4 of <xref target="RFC4648"/>, not this memo.</t>
    </section>

    <!-- ******************************************************************** -->

    <section anchor="SASL-OAUTH" title="OAuth SASL Mechanism Specifications">

      <t>SASL is used as an authentication framework in a variety of application layer protocols. This
        document defines the following SASL mechanisms for usage with OAuth:

	<list><t>
	<list style="hanging">
	  <t hangText="OAUTHBEARER:">OAuth 2.0 bearer tokens, as described in <xref target="RFC6750"/>. RFC 6750 uses 
		Transport Layer Security (TLS) to secure the protocol interaction between the client and the resource server.</t>
	  <t hangText="OAUTH10A:">OAuth 1.0a MAC tokens (using the HMAC-SHA1 keyed message digest), as described in Section 
		3.4.2 of <xref target="RFC5849"/>.
	     </t>
	</list>
	</t></list>

    New extensions may be defined to add additional OAuth Access Token Types. Such a new SASL OAuth 
	mechanism can be added by simply registering the new name(s) and citing this
	specification for the further definition.  
     </t>

     <t>These mechanisms are client initiated and lock-step, the server always replying to a client 
	message.  In the case where the client has and correctly uses a valid token the flow is:

	<list style="numbers">
	  <t>Client sends a valid and correct initial client response.
	     </t>
	  <t>Server responds with a successful authentication.
	   	  </t>
	</list>

	In the case where authentication fails the server sends an error result, then client MUST
	then send an additional message to the server in order to allow the server to finish the
	exchange.  Some protocols and common SASL implementations do not support both sending a SASL
	message and finalizing a SASL negotiation. The additional client message in the error case
	deals with this problem.  This exchange is:

	<list style="numbers">
		<t>Client sends an invalid initial client response.</t>
		<t>Server responds with an error message. </t>
		<t>Client sends a dummy client response.</t>
		<t>Server fails the authentication.</t>
	</list>
	</t>

      <section title="Initial Client Response">
        <t>Client responses are a GS2 <xref target="RFC5801"/> header followed by zero or more key/value pairs, or may be empty. The 
	gs2-header is defined here for compatibility with GS2 if a GS2 mechanism is formally defined, but this
        document does not define one.  These key/value pairs take the place of the corresponding HTTP headers and
        values to convey the information necessary to complete an OAuth style HTTP authorization.  
	Unknown key/value pairs MUST be ignored by the server. The ABNF <xref target="RFC5234"/> syntax is:
	</t>
	<t>
        <figure>
          <artwork>
            <![CDATA[
  kvsep          = %x01
  key            = 1*(ALPHA)
  value          = *(VCHAR / SP / HTAB / CR / LF )
  kvpair         = key "=" value kvsep
;;gs2-header     = See RFC 5801
  client_resp    = (gs2-header kvsep 0*kvpair kvsep) / kvsep
]]></artwork>
        </figure>
	  <!--   initial_client_resp = gs2-header kvsep client_resp
	    -->
	</t>
	<t>The GS2 header MAY include the user name associated with the resource being accessed, the "authzid".  
           It is worth noting that application protocols are allowed to require an authzid, as are specific server implementations. 
	</t>
	<t>The client response consisting of only a single kvsep is used only when authentication fails, 
	and is only valid in that context.  If sent as the first message from the client the server MAY
	simply fail the authentication without returning discovery information since there is no user or
	server name indication.
	</t>
	<t>The following keys and corresponding values are defined in the client response: 
	</t>
	<t><list><t>
	  <list style="hanging">
            <t hangText="auth (REQUIRED):">The payload that would be in the HTTP Authorization header
	                                   if this OAuth exchange was being carried out over HTTP.</t>
            <t hangText="host:">Contains the host name to which the client connected. In 
                                an HTTP context this is the value of the HTTP Host header. </t>
            <t hangText="port:">Contains the port number represented as a
				decimal positive integer string without leading zeros 
				to which the client connected.</t>
          </list>
        </t></list>
	</t>
	<t>
	For OAuth token types such as OAuth 1.0a that use keyed message digests the client MUST send host and
	port number key/values, and the server MUST fail an authorization request requiring
	keyed message digests that are not accompanied by host and port values.  <!-- For schemes 
	that require a URI scheme as part of the data being signed "http" is always used.--> In 
	OAuth 1.0a for example, the so-called "signature base string calculation" includes the reconstructed HTTP
	URL.
	</t>

	<section title="Reserved Key/Values">
	  <t> In these mechanisms values for path, query string and post body are 
	  assigned default values.  OAuth authorization schemes MAY define usage of
	  these in the SASL context and extend this specification.  For OAuth Access Token Types that 
	  include a keyed message digest of the request the default values MUST be used unless
	  explicit values are provided in the client response.  The following key
	  values are reserved for future use: 

	    <list><t>
		<list style="hanging">
		  <t hangText="mthd (RESERVED):">HTTP method, the default value is "POST".
		  </t>
		  <t hangText="path (RESERVED):">HTTP path data, the default value is "/".
		  </t>
		  <t hangText="post (RESERVED):">HTTP post data, the default value is "".
		  </t>
  	          <t hangText="qs (RESERVED):">The HTTP query string, the default value is "".  
  		  </t>
		</list>
	    </t></list>
	  </t>
	</section>


      </section>

      <section title="Server's Response">
      
      <t>The server validates the response according the specification for the
   	OAuth Access Token Types used.  If the OAuth Access Token Type utilizes a keyed message 
	digest of the request parameters then the client must provide a client
   	response that satisfies the data requirements for the scheme in use. 
	</t>

        <t>The server responds to a successfully verified client message by completing the SASL
        negotiation. The authenticated identity reported by the SASL mechanism is the
   	identity securely established for the client with
   	the OAuth credential.  The application, not the SASL mechanism, based on local
	access policy determines whether the identity reported by the mechanism 
	is allowed access to the requested resource.  Note that the semantics of the 
	authorization identity is specified by the SASL framework <xref target="RFC4422"/>.</t>
        
          <section title="OAuth Identifiers in the SASL Context">
          
          <t>In the OAuth framework the client may be authenticated by the authorization server 
		and the resource owner is authenticated to the authorization server. OAuth access 
		tokens may contain information about the authentication of the resource owner and 
		about the client and may therefore make this information accessible to the resource server.</t>
          		
		<t>If both identifiers
		are needed by an application the developer will need to provide a way to 
		communicate that from the SASL mechanism back to the application.<!--, such as 
		a GSS-API <xref target="RFC2743"/> named type like GSS_C_NT_USER_NAME or 
		a comparable newly defined GSS-API name type or name attribute <xref target="RFC6680"/>.-->
	     </t>
           </section>
      <section title="Server Response to Failed Authentication">

	<t>For a failed authentication the server returns a JSON <xref target="RFC7159"/> 
	formatted error result, and fails the authentication.  The error result consists 
	of the following values:

	<list><t>
          <list style="hanging">
            <t hangText="status (REQUIRED):">The authorization error code. Valid error codes are
				  defined in the IANA "OAuth Extensions Error Registry"
				  specified in the OAuth 2 core specification. 
            </t>
	    <t hangText="scope (OPTIONAL):">An OAuth scope which is valid to access the service. 
				This may be empty which implies that unscoped tokens are required, 
				or a scope value.  If a scope is specified then a single scope is 
				preferred, use of a space separated list of scopes is NOT RECOMMENDED.
                  </t>
	    <t hangText="openid-configuration (OPTIONAL):">The URL for a document following the 
	    OpenID Provider Configuration Information schema as described in OpenID Connect Discovery 
	    (OIDCD) <xref target="OpenID.Discovery" /> section 3 that is appropriate for the user.  
	    As specified in OIDCD this will have the "https" URL scheme. This document 
	    MUST have all OAuth related data elements populated.  The server MAY return different URLs 
	    for users in different domains and the client SHOULD NOT cache a single returned value and 
	    assume it applies for all users/domains that the server suports. 
	    The returned discovery document SHOULD have all data
	    elements required by the OpenID Connect Discovery specification
	    populated.  In addition, the discovery document SHOULD contain
	    the 'registration_endpoint' element to learn about the endpoint
	    to be used with the Dynamic Client Registration protocol
	    <xref target="I-D.ietf-oauth-dyn-reg"/> to obtain the minimum number of
	    parameters necessary for the OAuth protocol exchange to
	    function.  Another comparable discovery or client registration
	    mechanism MAY be used if available.
                  </t>
                  <t>
	    The use of the 'offline_access' scope, as defined in
	    <xref target="OpenID.Core"/> is RECOMMENDED to give clients the capability to
	    explicitly request a refresh token.
                  </t>
          </list>
        </t></list>
    </t>


    <t>If the resource server provides a scope then the client MUST always request scoped
	tokens from the token endpoint.  If the resource server provides no scope to the 
	client then the client SHOULD presume 
	an empty scope (unscoped token) is required to access the resource.
    </t>

    <t>
      Since clients may interact with a number of application servers,
      such as email servers and XMPP servers, they need to have a way
      to determine whether dynamic client registration has been performed
      already and whether an already available refresh token can be
      re-used to obtain an access token for the desired resource server.
      This specification RECOMMENDs that a client uses the information in
      the 'iss' element defined in OpenID Connect Core <xref target="OpenID.Core"/> 
      to make this determination.
    </t>
 
      </section>
      <section title="Completing an Error Message Sequence">
	<t>Section 3.6 of SASL <xref target="RFC4422"/> explicitly prohibits additional information
  	in an unsuccessful authentication outcome.  Therefore, the error
  	message is sent in a normal message.  The client MUST then send either an
  	additional client response consisting of a single %x01 (control A) character to 
	the server in order to allow the server to finish the exchange or send a SASL 
	cancellation token as generally defined in section 3.5 of SASL <xref target="RFC4422"/>.
	A specific example of a cancellation token can be found in IMAP <xref target="RFC3501"/> 
	section 6.2.2.
	</t>
      </section>

 </section>

      <section anchor="keyed-digests" title="OAuth Access Token Types using Keyed Message Digests">
<t>
OAuth Access Token Types may use keyed message digests and the client and the resource server may need to perform a cryptographic computation for integrity protection and data origin authentication.</t>

<t>OAuth is designed for access to resources identified by URIs.  SASL is designed for user authentication, and
   has no facility for more fine-grained access control.  In this specification we require or
          define default values for the data elements from an HTTP request which allow the
	  signature base string to be constructed properly.

          The default HTTP path is "/" and the default post body is empty.  These atoms are 
	  defined as extension points so
          that no changes are needed if there is a revision of SASL which supports more
          specific resource authorization, e.g., IMAP access to a specific folder or FTP access
          limited to a specific directory. </t>

        <t> Using the example in the OAuth 1.0a specification 
        as a starting point, on an IMAP server running on port 143 and given
        the OAuth 1.0a style authorization request (with %x01 shown as ^A and line breaks added 
	for readability) below: 
	</t>

<t><figure>
            <artwork><![CDATA[
n,a=user@example.com,^A
host=example.com^A
port=143^A
auth=OAuth realm="Example",
           oauth_consumer_key="9djdj82h48djs9d2",
           oauth_token="kkk9d7dh3k39sjv7",
           oauth_signature_method="HMAC-SHA1",
           oauth_timestamp="137131201",
           oauth_nonce="7d8f3e4a",
           oauth_signature="Tm90IGEgcmVhbCBzaWduYXR1cmU"^A^A
]]></artwork>
          </figure>
        </t>

        <t>The signature base string would be constructed per the OAuth 1.0 
	specification <xref target="RFC5849" /> with the following things noted:
	<list style="symbols">
		<t>The method value is defaulted to POST.</t>
		<t>The scheme defaults to be "http", and any port number other than 80 is included.</t>
		<t>The path defaults to "/".</t>
		<t>The query string defaults to "".</t>
	</list>
	In this example the signature base string with line breaks added for 
	readability would be:
	</t>
	<t><figure> 
            <artwork><![CDATA[
POST&http%3A%2F%2Fexample.com:143%2F&oauth_consumer_key%3D9djdj82h4
8djs9d2%26oauth_nonce%3D7d8f3e4a%26oauth_signature_method%3DHMAC-SH
A1%26oauth_timestamp%3D137131201%26oauth_token%3Dkkk9d7dh3k39sjv7
]]></artwork>
          </figure>
        </t>
      </section>
      

    </section>

    <!-- ******************************************************************** -->

    <section title="Examples">
      <t>These examples illustrate exchanges between IMAP and SMTP clients and servers.  All
         IMAP examples use SASL-IR  <xref target="RFC4959"/> and send payload in the initial 
         client response.   The Bearer Token examples assume encrypted transport, if the 
         underlying connection is not already TLS then STARTTLS MUST be used as TLS is required in the 
         Bearer Token specification. </t>

      <t>Note to implementers:  The SASL OAuth method names are case insensitive.  One example
	uses "Bearer" but that could as easily be "bearer", "BEARER", or "BeArEr".
	</t>

      <section title="Successful Bearer Token Exchange">

        <t>This example shows a successful OAuth 2.0 bearer token exchange in IMAP. Note that line 
	breaks are inserted for readability.  The underlying TLS establishment is not shown but is
	required for using Bearer Tokens per that specification.</t>
        <t>
          <figure>
            <artwork><![CDATA[
S: * OK IMAP4rev1 Server Ready
C: t0 CAPABILITY
S: * CAPABILITY IMAP4rev1 AUTH=OAUTHBEARER SASL-IR
S: t0 OK Completed
C: t1 AUTH OAUTHBEARER bixhPXVzZXJAZXhhbXBsZS5jb20sAWhvc3Q9c2
      VydmVyLmV4YW1wbGUuY29tAXBvcnQ9MTQzAWF1dGg9QmVhcmVyIHZGOWRmdDRxb
      VRjMk52YjNSbGNrQmhiSFJoZG1semRHRXVZMjl0Q2c9PQEB
S: t1 OK SASL authentication succeeded
]]></artwork>
          </figure>
        </t>
        <t>As required by IMAP <xref target="RFC3501"/>, the payloads are base64-encoded. The
          decoded initial client response (with %x01 represented as ^A and long lines
          wrapped for readability) is: 
	</t>
	<t><figure>
            <artwork><![CDATA[
n,a=user@example.com,^Ahost=server.example.com^Aport=143^A
auth=Bearer vF9dft4qmTc2Nvb3RlckBhbHRhdmlzdGEuY29tCg==^A^A
]]></artwork>
          </figure>
        </t>
        <t>The same credential used in an SMTP exchange is shown below.
	Note that line breaks are inserted for readability, and that the 
	SMTP protocol terminates lines with CR and LF characters (ASCII values 
	0x0D and 0x0A), these are not displayed explicitly in the example.  Again
	this example assumes that TLS is already established per the Bearer Token 
	specification requirements.</t>
        <t>
          <figure>
            <artwork><![CDATA[
[connection begins]
S: 220 mx.example.com ESMTP 12sm2095603fks.9
C: EHLO sender.example.com
S: 250-mx.example.com at your service,[172.31.135.47]
S: 250-SIZE 35651584
S: 250-8BITMIME
S: 250-AUTH LOGIN PLAIN OAUTHBEARER 
S: 250-ENHANCEDSTATUSCODES
S: 250-STARTTLS
S: 250 PIPELINING
[Negotiate TLS...]
C: t1 AUTH OAUTHBEARER bixhPXVzZXJAZXhhbXBsZS5jb20sAWhvc3Q9c
      2VydmVyLmV4YW1wbGUuY29tAXBvcnQ9MTQzAWF1dGg9QmVhcmVyIHZGOWRmdDR
      xbVRjMk52YjNSbGNrQmhiSFJoZG1semRHRXVZMjl0Q2c9PQEB
S: 235 Authentication successful.
[connection continues...]
            ]]></artwork>
          </figure>
        </t>


      </section>

    <!-- ******************************************************************** -->
      <section title="Successful OAuth 1.0a Token Exchange">
        <t>This IMAP example shows a successful OAuth 1.0a token exchange. Note 
	that line breaks are inserted for readability.  This example assumes that 
	TLS is already established. Signature computation is discussed in 
	<xref target="keyed-digests" />.</t>
        <t>
          <figure>
            <artwork><![CDATA[
S: * OK IMAP4rev1 Server Ready
C: t0 CAPABILITY
S: * CAPABILITY IMAP4rev1 AUTH=OAUTHBEARER OAUTH10A SASL-IR 
S: t0 OK Completed 
C: t1 AUTH OAUTH10A bixhPXVzZXJAZXhhbXBsZS5jb20sAWhvc3Q9ZXhhb
      XBsZS5jb20BcG9ydD0xNDMBYXV0aD1PQXV0aCByZWFsbT0iRXhhbXBsZSIsb2F1
      dGhfY29uc3VtZXJfa2V5PSI5ZGpkajgyaDQ4ZGpzOWQyIixvYXV0aF90b2tlbj0
      ia2trOWQ3ZGgzazM5c2p2NyIsb2F1dGhfc2lnbmF0dXJlX21ldGhvZD0iSE1BQy
      1TSEExIixvYXV0aF90aW1lc3RhbXA9IjEzNzEzMTIwMSIsb2F1dGhfbm9uY2U9I
      jdkOGYzZTRhIixvYXV0aF9zaWduYXR1cmU9IlRtOTBJR0VnY21WaGJDQnphV2R1
      WVhSMWNtVSUzRCIBAQ==
S: t1 OK SASL authentication succeeded
]]></artwork>
          </figure>
        </t>
        <t>As required by IMAP <xref target="RFC3501"/>, the payloads are
      base64-encoded. The
          decoded initial client response (with %x01 represented as ^A and lines
          wrapped for readability) is: </t>
        <t>
          <figure>
            <artwork><![CDATA[
n,a=user@example.com,^A
host=example.com^A
port=143^A
auth=OAuth realm="Example",
           oauth_consumer_key="9djdj82h48djs9d2",
           oauth_token="kkk9d7dh3k39sjv7",
           oauth_signature_method="HMAC-SHA1",
           oauth_timestamp="137131201",
           oauth_nonce="7d8f3e4a",
           oauth_signature="SSdtIGEgbGl0dGxlIHRlYSBwb3Qu"^A^A
]]></artwork>
          </figure>

        </t>

      </section>


   <!-- ******************************************************************** -->

      <section title="Failed Exchange">
        <t>This IMAP example shows a failed exchange because of the empty Authorization header, which is
          how a client can query for the needed scope. Note that line breaks are inserted for
          readability.</t>
        <t>
          <figure>
            <artwork><![CDATA[
S: * OK IMAP4rev1 Server Ready
C: t0 CAPABILITY
S: * CAPABILITY IMAP4rev1 AUTH=OAUTHBEARER SASL-IR 
S: t0 OK Completed 
C: t1 AUTH OAUTHBEARER bixhPXVzZXJAZXhhbXBsZS5jb20sAW
      hvc3Q9c2VydmVyLmV4YW1wbGUuY29tAXBvcnQ9MTQzAWF1dGg9AQE=
S: + eyJzdGF0dXMiOiJpbnZhbGlkX3Rva2VuIiwic2NvcGUiOiJleGFtcGxl
     X3Njb3BlIiwib3BlbmlkLWNvbmZpZ3VyYXRpb24iOiJodHRwczovL2V4
     YW1wbGUuY29tLy53ZWxsLWtub3duL29wZW5pZC1jb25maWd1cmF0aW9u
     In0=
C: AQ==
S: t1 NO SASL authentication failed
]]></artwork>
          </figure>
        </t>
        <t> The decoded initial client response is: </t>
        <t>
          <figure>
            <artwork><![CDATA[
n,a=user@example.com,^Ahost=server.example.com^A
port=143^Aauth=^A^A
            ]]></artwork>
          </figure>
        </t>
        <t> The decoded server error response is: </t>
        <t>
          <figure>
            <artwork><![CDATA[
{
"status":"invalid_token",
"scope":"example_scope",
"openid-configuration":"https://example.com/.well-known/openid-configuration"
}
            ]]></artwork>
          </figure>
        </t>
        <t>The client responds with the required dummy response, "AQ==" 
        is the base64 encoding of the ASCII value 0x01.  
	The same exchange using the IMAP specific method of cancelling an 
	AUTHENTICATE command sends "*" and is shown below. 
	</t>

        <t>
          <figure>
            <artwork><![CDATA[
S: * OK IMAP4rev1 Server Ready
C: t0 CAPABILITY
S: * CAPABILITY IMAP4rev1 AUTH=OAUTHBEARER SASL-IR IMAP4rev1
S: t0 OK Completed 
C: t1 AUTH OAUTHBEARER bixhPXVzZXJAZXhhbXBsZS5jb20sAW
      hvc3Q9c2VydmVyLmV4YW1wbGUuY29tAXBvcnQ9MTQzAWF1dGg9AQE=
S: + eyJzdGF0dXMiOiJpbnZhbGlkX3Rva2VuIiwic2NvcGUiOiJleGFtcGxl
     X3Njb3BlIiwib3BlbmlkLWNvbmZpZ3VyYXRpb24iOiJodHRwczovL2V4
     YW1wbGUuY29tLy53ZWxsLWtub3duL29wZW5pZC1jb25maWd1cmF0aW9u
     In0=
C: *
S: t1 NO SASL authentication failed
]]></artwork>
          </figure>
        </t>


      </section>


    <!-- ******************************************************************** -->
      <section title="SMTP Example of a Failed Negotiation">
        <t>This example shows an authorization failure in an SMTP exchange.  
	Note that line breaks are inserted for readability, and that the 
	SMTP protocol terminates lines with CR and LF characters (ASCII values 
	0x0D and 0x0A), these are not displayed explicitly in the example.  TLS
	negotiation is not shown but as noted above it is required for the use
	of Bearer Tokens.</t>
        <t>
          <figure>
            <artwork><![CDATA[
[connection begins]
S: 220 mx.example.com ESMTP 12sm2095603fks.9
C: EHLO sender.example.com
S: 250-mx.example.com at your service,[172.31.135.47]
S: 250-SIZE 35651584
S: 250-8BITMIME
S: 250-AUTH LOGIN PLAIN OAUTHBEARER
S: 250-ENHANCEDSTATUSCODES
S: 250 PIPELINING
C: AUTH OAUTHBEARER bix1c2VyPXNvbWV1c2VyQGV4YW1wbGUuY29tLAFhdXRoPUJlYXJl
       ciB2RjlkZnQ0cW1UYzJOdmIzUmxja0JoZEhSaGRtbHpkR0V1WTI5dENnPT0BAQ==
S: 334 eyJzdGF0dXMiOiI0MDEiLCJzY2hlbWVzIjoiYmVhcmVyIG1hYyIsInNjb3BlIjoia
       HR0cHM6Ly9tYWlsLmdvb2dsZS5jb20vIn0K
C: AQ==
S: 535-5.7.1 Username and Password not accepted. Learn more at
S: 535 5.7.1 http://support.example.com/mail/oauth
[connection continues...]
            ]]></artwork>
          </figure>
        </t>
        <t>The server returned an error message in the 334 SASL message, the
	client responds with the required dummy response, and 
	the server finalizes the negotiation.
	</t>
      </section>

    <!-- ******************************************************************** -->

    </section>

    <!-- ******************************************************************** -->

    <section title="Security Considerations">
    
    <t>OAuth 1.0a and OAuth 2 allows for a variety of deployment scenarios, and the security
 properties of these profiles vary. As shown in <xref target="overview"/> this specification is aimed to be integrated into a larger OAuth deployment. Application developers therefore need to understand the needs of their security requirements based on a threat assessment before selecting a specific SASL OAuth mechanism. For OAuth 2.0 a detailed security document <xref target="RFC6819"/> provides guidance to select those OAuth 2.0 components that help to mitigate threats for a given deployment. For OAuth 1.0a Section 4 of RFC 5849 <xref target="RFC5849"/> provides guidance specific to OAuth 1.0.</t>

   <t>This document specifies two SASL  Mechanisms for OAuth and each comes with different security properties. 
   
   <list style="hanging">
	  <t hangText="OAUTHBEARER:">This mechanism borrows from OAuth 2.0 bearer tokens <xref target="RFC6750"/>. It relies on the application using TLS to protect the OAuth 2.0 Bearer Token exchange; without TLS usage at the application layer this method is completely insecure. Consequently, TLS MUST be provided by the application when choosing this authentication mechanism.</t>
	  
	  <t hangText="OAUTH10A:">This mechanism re-uses OAuth 1.0a MAC tokens (using the HMAC-SHA1 keyed message digest), as described in Section 3.4.2 of <xref target="RFC5849"/>. To compute the keyed message digest in the same way was in RFC 5839 this specification conveys additional parameters between the client and the server. This SASL mechanism only supports client authentication. If server-side authentication is desireable then it must be provided by the application underneath the SASL layer. The use of TLS is strongly RECOMMENDED. 
	     </t>
	</list>
	</t>
	
	<t>Additionally, the following aspects are worth pointing out:  
	
	<list style="hanging"> 
	  <t hangText="An access token is not equivalent to the user's long term password."><vspace blankLines="1"/> 
	  
	  Care has to be
   taken when these OAuth credentials are used for actions like changing
   passwords (as it is possible with some protocols, e.g., XMPP <xref target="RFC6120"/>). The
   resource server should ensure that actions taken in the authenticated channel
   are appropriate to the strength of the presented credential.</t>
	  
	  <t hangText="Lifetime of the appliation sessions."><vspace blankLines="1"/> 
	  It is possible that 
	  SASL will be authenticating a connection and the
   life of that connection may outlast the life of the access token used
   to establish it.  This is a common problem in application protocols
   where connections are long-lived, and not a problem with this
   mechanism per se. Resource servers may unilaterally disconnect clients in
   accordance with the application protocol.</t>


   <t hangText="Access tokens have a lifetime."><vspace blankLines="1"/> 
   Reducing the lifetime of an access
   token provides security benefits and OAuth 2.0 introduces refresh
   tokens to obtain new access token on the fly without any need for a human interaction. 
    Additionally, a previously obtained access token might be revoked or rendered invalid
   at any time. The client MAY request a new access token for each
   connection to a resource server, but it SHOULD cache and re-use
   valid credentials.</t>

	</list> 
	</t>
	
    </section>
    
    <!-- ******************************************************************** -->
    
     <section title="Internationalization Considerations">
	     <t>The identifer asserted by the OAuth authorization server about the resource owner inside the access token may be displayed to a human. For example, when SASL is used in the context of IMAP the client may assert the resource owner's email address to the IMAP server for usage in an email-based application. The identifier may therefore contain internationalized characters and an application needs to ensure that the mapping between the identifier provided by OAuth is suitable for use with the application layer protocol SASL is incorporated into.</t>
	     
	     <t>At the time of writing the standardization of the various claims in the access token (in JSON format) is still ongoing, see <xref target="I-D.ietf-oauth-json-web-token"/>. Once completed it will provide a standardized format for exchanging identity information between the authorization server and the resource server.</t>  
  
    </section>



    <!-- ******************************************************************** -->

    <section title="IANA Considerations">
     <section title="SASL Registration">
      <t> The IANA is requested to register the following SASL profile: <list style="empty">
          <t>SASL mechanism profile: OAUTHBEARER</t>
          <t>Security Considerations: See this document</t>
          <t>Published Specification: See this document</t>
          <t>For further information: Contact the authors of this document.</t>
          <t>Owner/Change controller: the IETF</t>
          <t>Note: None</t>
        </list>
      </t>
      <t> The IANA is requested to register the following SASL profile: <list style="empty">
          <t>SASL mechanism profile: OAUTH10A</t>
          <t>Security Considerations: See this document</t>
          <t>Published Specification: See this document</t>
          <t>For further information: Contact the authors of this document.</t>
          <t>Owner/Change controller: the IETF</t>
          <t>Note: None</t>
        </list>
      </t>
     </section>
      <!-- 
     <section title="GSS-API Registration">
        <t>IANA is further requested to assign an OID for these GSS mechanisms
   in the SMI numbers registry, with the prefix of
   iso.org.dod.internet.security.mechanisms (1.3.6.1.5.5) and to
   reference this specification in the registry.</t>
    </section> 
    -->

    </section>

    <!-- ******************************************************************** -->
    <!-- ******************************************************************** -->

  </middle>

  <back>

    <references title="Normative References">
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.2244.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.3174.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.4422.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.5234.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.5246.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.5849.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.5801.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.4648.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.6749.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.6750.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.7159.xml' ?>

<reference anchor="OpenID.Discovery">
        <front>
          <title>OpenID Connect Discovery 1.0</title>

          <author fullname="Nat Sakimura" initials="N." surname="Sakimura">
            <organization abbrev="NRI">Nomura Research Institute,
            Ltd.</organization>
          </author>

          <author fullname="John Bradley" initials="J." surname="Bradley">
            <organization abbrev="Protiviti">Protiviti Government
            Services</organization>
          </author>

          <author fullname="Michael B. Jones" initials="M.B." surname="Jones">
            <organization abbrev="Microsoft">Microsoft</organization>
          </author>

          <author fullname="Edmund Jay" initials="E." surname="Jay">
            <organization abbrev="MGI1">MGI1</organization>
          </author>

          <date day="12" month="July" year="2011" />
        </front>

        <format target="http://openid.net/specs/openid-connect-discovery-1_0.html"
                type="HTML" />
      </reference>

      <reference anchor="OpenID.Core">
        <front>
          <title>OpenID Connect Core 1.0</title>

          <author fullname="Nat Sakimura" initials="N." surname="Sakimura">
            <organization abbrev="NRI">Nomura Research Institute, Ltd.</organization>
          </author>

          <author fullname="John Bradley" initials="J." surname="Bradley">
            <organization abbrev="Ping Identity">Ping Identity</organization>
          </author>

          <author fullname="Michael B. Jones" initials="M.B." surname="Jones">
            <organization abbrev="Microsoft">Microsoft</organization>
          </author>

          <author fullname="Breno de Medeiros" initials="B." surname="de Medeiros">
            <organization abbrev="Google">Google</organization>
          </author>

	  <author fullname="Chuck Mortimore" initials="C." surname="Mortimore">
	    <organization abbrev="Salesforce">Salesforce</organization>
	  </author>

          <date day="25" month="February" year="2014"/>
        </front>

	<format target="http://openid.net/specs/openid-connect-core-1_0.html"
                type="HTML" />
      </reference>


    </references>

    <references title="Informative References">
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.2616.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.3501.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.4959.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.5321.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.6120.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.6819.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.7033.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-oauth-json-web-token.xml' ?>
      <?rfc include='http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-oauth-dyn-reg.xml' ?>
    </references>

    <section  title='Acknowlegements'>
	<t>
	The authors would like to thank the members of the Kitten working group, and in 
	addition and specifically: Simon Josefson, Torsten Lodderstadt, Ryan Troll, Alexey Melnikov, 
	Jeffrey Hutzelman, Nico Williams, Matt Miller, and Benjamin Kaduk.
	</t>
	<t>
   This document was produced under the chairmanship of Alexey Melnikov, Tom Yu, Shawn Emery, Josh Howlett, Sam Hartman.
   The supervising area director was Stephen Farrell.
   </t>
    </section>
    <section  title='Document History'>
      <t>
        [[ to be removed by RFC editor before publication as an RFC ]]
      </t>

      <t>
        -19
      </t>
      <t>
        <list style='symbols'>
          <t>
            Last call feedback agaiun.  
          </t>
          <t>
            Clarified usage of TLS in examples and fixed them some more.  Adding reference to RFC4422 
	    and cancellation token and an example for that.
          </t>
        </list>
      </t>

      <t>
        -18
      </t>
      <t>
        <list style='symbols'>
          <t>
            Last call feedback round #5.  Fixed -17 change log.
          </t>
          <t>
            Corrected "issue" to "iss", other minor changes.
          </t>
        </list>
      </t>

      <t>
        -17
      </t>
      <t>
        <list style='symbols'>
          <t>
            Last call feedback again (WGLC #4).  eradicated comma splicing.  Removed extra server message in example 4.3.
          </t>
          <t>
            Added recommendations for discovery and dynamic client registration support.
          </t>
        </list>
      </t>

      <t>
        -16
      </t>
      <t>
        <list style='symbols'>
          <t>
            Last call feedback again.  Primarily editorial changes.  Corrected examples.
          </t>
        </list>
      </t>

      <t>
        -15
      </t>
      <t>
        <list style='symbols'>
          <t>
            Last call feedack on the GS2 stuff being ripped out completely.
          </t>
          <t>
	    Removed the "user" parameter and put stuff back into the gs2-header.  
	    Call out that the authzid goes in the gs2-header with some prose about 
	    when it might be required. Very comparable to -10.            
	  </t>
          <t>
	    Added an OAuth 1.0A example explicitly.  
          </t>
        </list>
      </t>
      <t>
        -14
      </t>
      <t>
        <list style='symbols'>
          <t>
            Last call feedack on RFC citations needed, small editorial.
          </t>
          <t>
            Added the "user" parameter back, which was pulled when we started down 
            the GS2 path.  Same language as -03.  
          </t>
          <t>
            Defined a stub GS2 header to make sure that when the GS2 bride is 
            defined for this that nothing will break when it actually starts to get 
	    populated.
          </t>
        </list>
      </t>
      <t>
        -13
      </t>
      <t>
        <list style='symbols'>
          <t>
            Changed affiliation.
          </t>
        </list>
      </t>

      <t>
        -12
      </t>
      <t>
        <list style='symbols'>
          <t>
            Removed -PLUS components from the specification.
          </t>
        </list>
      </t>
	  <t>
        -11
      </t>
      <t>
        <list style='symbols'>
          <t>
            Removed GSS-API components from the specification.
          </t>
          <t>
	  Updated security consideration section.
          </t>
        </list>
      </t>


	  <t>
        -10
      </t>
      <t>
        <list style='symbols'>
          <t>
	  Clarifications throughout the document in response to the feedback from Jeffrey Hutzelman.
          </t>
        </list>
      </t>
      <t>
        -09
      </t>
      <t>
        <list style='symbols'>
          <t>
	  Incorporated review by Alexey and Hannes. 
          </t>
          <t>
      Clarified the three OAuth SASL mechanisms.
           </t>
           <t>Updated references</t>
           <t>Extended acknowledgements</t>
        </list>
      </t>


      <t>
        -08
      </t>
      <t>
        <list style='symbols'>
          <t>
	  Fixed the channel binding examples for p=$cbtype
          </t>
          <t>
	  More tuning of the authcid language and edited and renamed 3.2.1.
          </t>
        </list>
      </t>

      <t>
        -07
      </t>
      <t>
        <list style='symbols'>
          <t>
	  Struck the MUST langiage from authzid.
          </t>
          <t>
          </t>
        </list>
      </t>

      <t>
        -06
      </t>
      <t>
        <list style='symbols'>
          <t>
	  Removed the user field.  Fixed the examples again.
          </t>
          <t>Added canonicalization language.
          </t>
          <t>
          </t>
        </list>
      </t>

      <t>
        -05
      </t>
      <t>
        <list style='symbols'>
          <t>
	  Fixed the GS2 header language again.
          </t>
          <t>
	  Separated out different OAuth schemes into different SASL mechanisms.  Took out the 
	  scheme in the error return.  Tuned up the IANA registrations.
          </t>
          <t>
	  Added the user field back into the SASL message.
          </t>
          <t>
	  Fixed the examples (again).
          </t>
          <t>
          </t>
        </list>
      </t>

      <t>
        -04
      </t>
      <t>
        <list style='symbols'>
          <t>
	  Changed user field to be carried in the gs2-header, and made gs2 header explicit in all cases.
          </t>
          <t>
	  Converted MAC examples to OAuth 1.0a.  Moved MAC to an informative reference.
          </t>
          <t>
	  Changed to sending an empty client response (single control-A) as the second message of a failed sequence.
          </t>
          <t>
	  Fixed channel binding prose to refer to the normative specs and removed the hashing of large channel 
	  binding data, which brought mroe problems than it solved.
          </t>
          <t>
	  Added a SMTP examples for Bearer use case.
          </t>
        </list>
      </t>

      <t>
        -03
      </t>
      <t>
        <list style='symbols'>
          <t>
	  Added user field into examples and fixed egregious errors there as well.
          </t>
          <t>
	  Added text reminding developers that Authorization scheme names are case insensitive.
          </t>
        </list>
      </t>

      <t>
        -02
      </t>
      <t>
        <list style='symbols'>
          <t>
	  Added the user data element back in.
          </t>
          <t>
	  Minor editorial changes.
          </t>
        </list>
      </t>

      <t>
        -01
      </t>
      <t>
        <list style='symbols'>
          <t>
	  Ripping out discovery.  Changed to refer to I-D.jones-appsawg-webfinger instead
      of WF and SWD older drafts.
          </t>
          <t>
	  Replacing HTTP as the message format and adjusted all examples.
          </t>
        </list>
      </t>

      <t>
        -00
      </t>
      <t>
        <list style='symbols'>
          <t>
	    Renamed draft into proper IETF naming format now that it's adopted.
          </t>
          <t>
	    Minor fixes.
          </t>
        </list>
      </t>
    </section>


  </back>
</rfc>
